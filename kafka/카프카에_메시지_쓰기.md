

이번 장에서는 카프카 프로듀서를 작성하고 사용하는 방법에 대해 배운다.

프로듀서의 개념과 관련 컴포넌트
KarfaProducer와 ProducerRecord 객체를 생성하는 방법
카프카에 데이터를 전송하는 방법
카프카가 반환할 수 있는 에러를 처리하는 방법
카프카 프로듀서의 실행을 제어하는 데, 중요한 구성 옵션
파티션 처리 방법과 직렬처리기(serializer) 사용 및 작성 방법

# 3.1 프로듀서 개요
애플리케이션이 카프카에 메세지를 써야하는 이유는 다양하고, 또한 다양한 요구사항이 존재한다.
(웹 사이트 사용자 활동 수집, 모니터링용, 다른 애플리케이션과의 비동기 통신, etc... / 일부 메세지 유실이나 복제 허용, 대기시간 etc...) 

서로 다른 용도와 요구사항은 카프카 메세지를 쓰는 프로듀서 API를 사용하는 방법과 구성에 영향을 미침


프로듀서가 데이터가 데이터를 전송할 때 내부적으로 처리되는 단계는 다음과 같다.
        

1. 카프카에 쓰려는 메시지를 갖는 ProducerRecord를 생성 (전송할 토픽과 값을 포함, 선택적으로 Key 값과 파티션 지정 가능)

2. 메세지 객체들이 네트워크로 전송될 수 있도록 바이트 배열로 직렬화  진행, 직렬처리기(serializer)와 컴포넌트(클래스)가 처리

3. 해당 데이터는 파티셔너와 컴포넌트(클래스)에 전달

파티션 지정 않았다면, ProducerRecord의 키를 기준으로 파티셔너가 하나의 파티션 선택
파티션이 선택되면 해당 레코드(ProducerRecord 객체)의 메시지가 저장될 토픽과 파티션을 프로듀서가 알게됨
토픽과 파티션으로 전송될 레코드들을 모은 레코드 배치 추가, 별개의 스레드가 그 배치를 카프카 브로커에 전송
4. 브로커 수신된 메시지 처리 후 응답

성공 → RecodrMetadata 객체 반환(토픽, 파티션, 패티션 내부의 메시지 오프셋 제공)
실패 → 에러 반환 (에러 수신한 프로듀서는 메시지 쓰기 포기하고 에러 반환전에 몇번 더 재전송 시도 할 수 있음)


# 3.2 카프카 프로듀서 구성하기
카프카 프로듀서를 수행하는 객체는 ProducerRecord
카프카에 메시지를 쓰려면 ProducerRecord 객체를 먼저 생성
ProducerRecord 은 세개의 필수 속성을 갖음 (이 외에도 원하는 속성 설정 가능)
bootstrap.servers
카프카 클러스터에 최초 연결을 위해 프로듀서가 사용하는 브로커들의 host:port 목록을 설정
key.serializer
프로듀서가 생성하는 레코드(ProducerRecord 객체)의 메시지 키를 직렬화하기 위한 클래스 이름을 이 속성에 설정 (key 없이 값만 전송할 때도 key.serializer 설정 필요)
key.serializer에 설정하는 클래스는 "org.apache.kafka.common.serialization.Serializer" 인터페이스를 구현해야 함
카프카 클라이언트 패키지에는 다음과 같은 3가지 Serializer가 포함되어 있다.
ByteArraySerializer, StringSerializer,IntegerSerializer

따라서 많이 사용하는 타입들을 직렬화 할때는 따로 직렬처리기를 구현하지 않아도 됨
value.serializer
레코드 메시지 값 직렬화 하는 데 사용되는 클래스 이름을 여기서 설정
직렬화 방법은 key.serializer와 동일
private Properties kafkaProps = new Properties ();		// 1. 카프카 Properties 객체 생성
kafkaProps.put("bootstrap.servers", "brokerl:9892,broker:9892");

kafkaProps.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer"); //  메세지 key와 value 모두 문자열 타입 사용으로 StringSerializer 사용
kafkaProps.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer"); 

Producer<String, String> producer = new KafkaProducer <String, String>(kafkaProps);		// 새로운 프로듀서 객체 생성, 메세지 key, value (예시는 String)을 설정하고 Properties 객체를 생성자 인자로 전달


자세한 설정 참조 :  http://kafka.apache.org/documentation.html#producerconfigs



메세지 전송 방법에는 3가지
Fire-and-forget(전송 후 망각)

Synchronous send(동기식 전송)

Asynchronous send(비동기식 전송)

# 3.3 카프카에 메시지 전송하기
## 3.3.1 동기식으로 메시지 전송하기
## 3.3.2 비동기식으로 메시지 전송하기
# 3.4 프로듀서 구성하기
# 3.5 직렬처리기
## 3.5.1 커스텀 직렬처리기
## 3.5.2 아파치 Avro를 사용해서 직렬화하기
## 3.5.4 카프카에서 Avro 레코드 사용하기
# 3.6 파티션
# 3.7 구버전의 프로듀서 API들
# 3.8 요약
